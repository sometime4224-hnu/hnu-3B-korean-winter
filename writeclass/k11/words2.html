<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>서사(시간 순서) 학습 웹앱 - TOPIK 3-4급</title>
  <style>
    :root{
      --bg:#fbf7f2;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --line:#e5e7eb;
      --accent:#2563eb;
      --ok:#16a34a;
      --bad:#dc2626;
      --chip:#f3f4f6;
      --shadow: 0 10px 30px rgba(0,0,0,.06);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
      background: linear-gradient(180deg, var(--bg), #fff);
      color:var(--ink);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(251,247,242,.75);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:14px 16px;}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}
    .controls{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
    }
    .btn, select, input{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      font-size:14px;
      color:var(--ink);
      outline:none;
    }
    .btn{cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.ghost{background:transparent}
    .btn.small{padding:8px 10px;border-radius:10px;font-size:13px}
    .btn:active{transform:translateY(1px)}
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;
    }
    .tab{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-size:14px;
    }
    .tab.active{background:var(--ink);color:#fff;border-color:var(--ink)}
    main{max-width:1100px;margin:0 auto;padding:16px}
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .panel{
      grid-column: span 12;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .row{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      border-bottom:1px dashed var(--line);
      padding-bottom:10px;
      margin-bottom:12px;
    }
    .progress{
      width:260px; max-width: 100%;
      height:10px; border-radius:999px;
      background: #f1f5f9;
      overflow:hidden;
      border:1px solid var(--line);
    }
    .bar{height:100%; width:0%; background: linear-gradient(90deg, var(--accent), #60a5fa);}
    .meta{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .chip{
      background:var(--chip);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }
    .cards{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .card{
      grid-column: span 6;
      background:#fff;
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: 0 6px 18px rgba(0,0,0,.05);
    }
    @media (max-width: 900px){ .card{grid-column: span 12;} }
    .kterm{
      display:flex; gap:10px; align-items:baseline; justify-content:space-between;
    }
    .term{
      font-size:18px; font-weight:700;
      letter-spacing:-.2px;
    }
    .tag{
      font-size:12px;
      color:var(--muted);
      background:var(--chip);
      border:1px solid var(--line);
      padding:4px 8px;
      border-radius:999px;
      white-space:nowrap;
    }
    details{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
    }
    details > summary{
      cursor:pointer;
      font-weight:600;
      color:var(--ink);
      list-style:none;
    }
    details > summary::-webkit-details-marker{display:none}
    .muted{color:var(--muted); font-size:13px; line-height:1.55}
    .ex{
      margin-top:8px;
      padding:10px 12px;
      background: #f8fafc;
      border:1px solid var(--line);
      border-radius:12px;
      font-size:14px;
      line-height:1.6;
    }
    .actions{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;
    }
    .btn.ok{border-color: rgba(22,163,74,.35); background: rgba(22,163,74,.08); color: #0f5132;}
    .btn.bad{border-color: rgba(220,38,38,.35); background: rgba(220,38,38,.06); color: #7f1d1d;}
    .btn.sound{border-color: rgba(37,99,235,.35); background: rgba(37,99,235,.06); color: #1e3a8a;}
    .status{
      margin-left:auto;
      font-size:12px;
      color:var(--muted);
    }
    .status.known{color: var(--ok); font-weight:700;}
    .status.again{color: var(--bad); font-weight:700;}
    .divider{height:1px;background:var(--line);margin:12px 0}
    /* Quiz */
    .qbox{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      background:#fff;
    }
    .qtitle{font-weight:800;margin:0 0 8px 0}
    .opts{display:grid; gap:8px; margin-top:10px}
    .opt{
      text-align:left;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      cursor:pointer;
      font-size:14px;
    }
    .opt.correct{border-color: rgba(22,163,74,.5); background: rgba(22,163,74,.08)}
    .opt.wrong{border-color: rgba(220,38,38,.5); background: rgba(220,38,38,.08)}
    .feedback{margin-top:10px;font-size:13px}
    .feedback.ok{color:var(--ok);font-weight:700}
    .feedback.bad{color:var(--bad);font-weight:700}
    /* Timeline reorder */
    .dndWrap{display:grid; gap:10px}
    .dndList{
      list-style:none; padding:0; margin:0;
      display:grid; gap:8px;
    }
    .dndItem{
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      cursor:grab;
      user-select:none;
    }
    .dndItem.dragging{opacity:.6}
    footer{color:var(--muted);font-size:12px;padding:18px 16px;max-width:1100px;margin:0 auto}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>서사(시간 순서) 학습 웹앱 (TOPIK 3-4급)</h1>
        <div class="sub">어휘·표현·문법을 카드로 학습하고, 퀴즈로 확인합니다. (로컬 저장: 브라우저)</div>
      </div>
      <div class="controls">
        <input id="search" type="search" placeholder="검색 (예: 이후, -고 나서)" />
        <select id="lang">
          <option value="both">뜻: 한국어+베트남어</option>
          <option value="vi">뜻: 베트남어 중심</option>
          <option value="ko">뜻: 한국어 중심</option>
        </select>
        <button class="btn ghost" id="reset">학습기록 초기화</button>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="vocab">어휘</button>
      <button class="tab" data-tab="expr">표현</button>
      <button class="tab" data-tab="gram">문법</button>
      <button class="tab" data-tab="quiz">퀴즈</button>
    </div>
  </div>
</header>

<main>
  <section class="panel" id="overview">
    <div class="row">
      <div class="meta">
        <span class="chip" id="countChip">전체 0개</span>
        <span class="chip" id="knownChip">알아요 0개</span>
        <span class="chip" id="againChip">다시 0개</span>
      </div>
      <div class="meta" style="gap:8px">
        <div class="progress" aria-label="progress"><div class="bar" id="bar"></div></div>
        <span class="chip" id="pctChip">0%</span>
      </div>
    </div>
    <div class="muted">
      학습 팁: 서사는 “먼저→다음→그 후→그러던 중→그래서→마지막으로” 같은 연결어로 시간 흐름을 고정하면 안정적으로 설명할 수 있습니다.
    </div>
  </section>

  <section class="panel" id="content"></section>
</main>

<footer>
  Web Speech API(브라우저 TTS)를 지원하는 경우 “발음” 버튼이 동작합니다. 일부 브라우저/기기에서는 한국어·베트남어 음성이 없을 수 있습니다.
</footer>

<script>
/* -------------------- Data -------------------- */
const DATA = {
  vocab: [
    {
      id:"v1", term:"순서", kind:"어휘",
      koDef:"사건이나 행동을 배열하는 차례",
      viDef:"thứ tự, trình tự",
      koEx:"설명의 순서를 시간대로 정해 봅시다.",
      viEx:"Hãy sắp xếp thứ tự giải thích theo trình tự thời gian."
    },
    {
      id:"v2", term:"과정", kind:"어휘",
      koDef:"일이 진행되는 흐름",
      viDef:"quá trình",
      koEx:"문제가 해결되는 과정을 이야기해 보세요.",
      viEx:"Hãy kể về quá trình vấn đề được giải quyết."
    },
    {
      id:"v3", term:"사건", kind:"어휘",
      koDef:"이야기 속에서 일어난 일",
      viDef:"sự kiện, việc xảy ra",
      koEx:"그날 가장 중요한 사건이 뭐였어요?",
      viEx:"Hôm đó sự kiện quan trọng nhất là gì?"
    },
    {
      id:"v4", term:"계기", kind:"어휘",
      koDef:"어떤 일이 시작되는 원인·단서",
      viDef:"cơ duyên/động lực, nguyên nhân khởi đầu",
      koEx:"유학을 오게 된 계기가 있었어요.",
      viEx:"Có một lý do/cơ duyên khiến tôi quyết định đi du học."
    },
    {
      id:"v5", term:"이후", kind:"어휘",
      koDef:"그 뒤의 시간(비교적 공식적)",
      viDef:"sau đó (trang trọng)",
      koEx:"수업이 끝난 이후 도서관에 갔어요.",
      viEx:"Sau khi buổi học kết thúc, tôi đã đến thư viện."
    },
    {
      id:"v6", term:"직후", kind:"어휘",
      koDef:"바로 뒤(시간 간격이 매우 짧음)",
      viDef:"ngay sau đó",
      koEx:"수업 직후에 전화가 왔어요.",
      viEx:"Ngay sau giờ học, tôi nhận được cuộc gọi."
    },
    {
      id:"v7", term:"그때", kind:"어휘",
      koDef:"특정 시점을 짚어 말할 때",
      viDef:"lúc đó",
      koEx:"그때 저는 이미 집에 있었어요.",
      viEx:"Lúc đó tôi đã ở nhà rồi."
    },
    {
      id:"v8", term:"중간에", kind:"어휘",
      koDef:"흐름이 진행되는 사이에",
      viDef:"giữa chừng",
      koEx:"중간에 비가 와서 계획이 바뀌었어요.",
      viEx:"Giữa chừng trời mưa nên kế hoạch đã thay đổi."
    },
    {
      id:"v9", term:"마침내", kind:"어휘",
      koDef:"오래 걸린 뒤 최종 도달",
      viDef:"cuối cùng (sau thời gian dài)",
      koEx:"여러 번 실패했지만 마침내 성공했어요.",
      viEx:"Dù thất bại nhiều lần, cuối cùng tôi đã thành công."
    },
    {
      id:"v10", term:"결국", kind:"어휘",
      koDef:"여러 과정을 거친 뒤 결과를 정리할 때",
      viDef:"rốt cuộc",
      koEx:"여러 방법을 써 봤지만 결국 포기했어요.",
      viEx:"Tôi đã thử nhiều cách nhưng rốt cuộc vẫn bỏ cuộc."
    }
  ],
  expr: [
    {
      id:"e1", term:"먼저 / 우선", kind:"표현",
      koDef:"이야기의 시작 단계 제시",
      viDef:"trước tiên",
      koEx:"우선 준비를 했어요.",
      viEx:"Trước tiên tôi đã chuẩn bị."
    },
    {
      id:"e2", term:"다음(으로)", kind:"표현",
      koDef:"다음 단계로 이동",
      viDef:"tiếp theo",
      koEx:"다음으로 버스를 탔어요.",
      viEx:"Tiếp theo tôi đã lên xe buýt."
    },
    {
      id:"e3", term:"그 후(에)", kind:"표현",
      koDef:"이후 사건 연결(중립·서술체)",
      viDef:"sau đó",
      koEx:"그 후에 친구를 만났어요.",
      viEx:"Sau đó tôi đã gặp bạn."
    },
    {
      id:"e4", term:"그러고 나서", kind:"표현",
      koDef:"앞 사건 다음에 이어짐(구어)",
      viDef:"rồi sau đó (khẩu ngữ)",
      koEx:"숙제를 했어요. 그러고 나서 잤어요.",
      viEx:"Tôi làm bài tập. Rồi sau đó tôi đi ngủ."
    },
    {
      id:"e5", term:"그러던 중(에)", kind:"표현",
      koDef:"진행 중 끼어드는 사건",
      viDef:"đang lúc đó thì",
      koEx:"걷고 있었는데 그러던 중에 전화가 왔어요.",
      viEx:"Tôi đang đi bộ thì đúng lúc đó có cuộc gọi."
    },
    {
      id:"e6", term:"한편", kind:"표현",
      koDef:"같은 시간대의 다른 흐름 제시",
      viDef:"trong khi đó / mặt khác",
      koEx:"한편 친구는 다른 길로 갔어요.",
      viEx:"Trong khi đó, bạn tôi đi đường khác."
    },
    {
      id:"e7", term:"동시에", kind:"표현",
      koDef:"같은 시간에 함께 일어남",
      viDef:"đồng thời",
      koEx:"문이 열리자 동시에 사람들이 들어왔어요.",
      viEx:"Cửa vừa mở ra thì đồng thời mọi người bước vào."
    },
    {
      id:"e8", term:"그래서", kind:"표현",
      koDef:"원인 → 결과 연결(서사 기본)",
      viDef:"vì vậy",
      koEx:"비가 많이 왔어요. 그래서 못 갔어요.",
      viEx:"Trời mưa nhiều. Vì vậy tôi không đi được."
    },
    {
      id:"e9", term:"하지만 / 그런데", kind:"표현",
      koDef:"예상과 다른 전개(대조·전환)",
      viDef:"nhưng / thế mà",
      koEx:"준비를 했어요. 그런데 버스가 안 왔어요.",
      viEx:"Tôi đã chuẩn bị. Thế mà xe buýt không đến."
    },
    {
      id:"e10", term:"마지막으로", kind:"표현",
      koDef:"결말·정리 단계",
      viDef:"cuối cùng (khi trình bày)",
      koEx:"마지막으로 결과를 말하겠습니다.",
      viEx:"Cuối cùng, tôi xin nói về kết quả."
    }
  ],
  gram: [
    {
      id:"g1", term:"-고 나서", kind:"문법",
      koDef:"A를 한 뒤에 B를 함",
      viDef:"sau khi A thì B",
      koEx:"밥을 먹고 나서 약을 먹었어요.",
      viEx:"Sau khi ăn cơm, tôi uống thuốc."
    },
    {
      id:"g2", term:"-자마자", kind:"문법",
      koDef:"A 직후 곧바로 B(시간 간격 매우 짧음)",
      viDef:"vừa mới A thì ngay lập tức B",
      koEx:"집에 오자마자 씻었어요.",
      viEx:"Vừa về đến nhà là tôi tắm ngay."
    },
    {
      id:"g3", term:"-다가", kind:"문법",
      koDef:"하던 중에 멈추거나 다른 일로 전환",
      viDef:"đang A thì (chuyển sang) B",
      koEx:"공부하다가 잠이 들었어요.",
      viEx:"Đang học thì tôi ngủ thiếp đi."
    },
    {
      id:"g4", term:"-던", kind:"문법",
      koDef:"과거에 하던/진행 중이던 배경(회상·설명)",
      viDef:"đang/đã từng (quá khứ, hồi tưởng)",
      koEx:"제가 기다리던 사람이 왔어요.",
      viEx:"Người mà tôi đang chờ (hồi đó) đã đến."
    },
    {
      id:"g5", term:"-게 되다", kind:"문법",
      koDef:"변화·결과 도달(서사 결론에 자주 사용)",
      viDef:"cuối cùng thì / trở nên",
      koEx:"여러 번 연습해서 잘하게 됐어요.",
      viEx:"Luyện tập nhiều lần nên cuối cùng tôi làm tốt hơn."
    },
    {
      id:"g6", term:"-는 바람에", kind:"문법",
      koDef:"예상 밖 원인 때문에 주로 좋지 않은 결과",
      viDef:"vì ... mà (kết quả xấu/ngoài ý muốn)",
      koEx:"비가 오는 바람에 행사가 취소됐어요.",
      viEx:"Vì trời mưa nên sự kiện đã bị hủy."
    }
  ]
};

const ALL = [...DATA.vocab, ...DATA.expr, ...DATA.gram];

/* -------------------- State (localStorage) -------------------- */
const LS_KEY = "narrative_app_state_v1";
const state = loadState();

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return { marks:{} };
    const parsed = JSON.parse(raw);
    if(!parsed || typeof parsed !== "object") return { marks:{} };
    return { marks: parsed.marks || {} };
  }catch(e){
    return { marks:{} };
  }
}
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}

/* -------------------- Helpers -------------------- */
const $ = (sel) => document.querySelector(sel);
const el = (tag, attrs={}, children=[]) => {
  const n = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==="class") n.className = v;
    else if(k==="html") n.innerHTML = v;
    else if(k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
    else n.setAttribute(k, v);
  });
  children.forEach(c => n.appendChild(c));
  return n;
};

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function speak(text, langHint="ko-KR"){
  if(!("speechSynthesis" in window)) return alert("이 브라우저는 TTS를 지원하지 않습니다.");
  const u = new SpeechSynthesisUtterance(text);
  // best-effort language selection
  u.lang = langHint;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

function getMark(id){ return state.marks[id] || "none"; } // none | known | again
function setMark(id, val){
  state.marks[id] = val;
  saveState();
  render();
}

function filtered(items){
  const q = ($("#search").value || "").trim().toLowerCase();
  if(!q) return items;
  return items.filter(x => {
    const blob = `${x.term} ${x.koDef} ${x.viDef} ${x.koEx} ${x.viEx}`.toLowerCase();
    return blob.includes(q);
  });
}

function updateOverview(){
  const total = filtered(currentItems()).length;
  const marks = state.marks || {};
  const ids = new Set(filtered(currentItems()).map(x=>x.id));
  let known=0, again=0;
  ids.forEach(id=>{
    if(marks[id]==="known") known++;
    if(marks[id]==="again") again++;
  });
  $("#countChip").textContent = `현재 목록 ${total}개`;
  $("#knownChip").textContent = `알아요 ${known}개`;
  $("#againChip").textContent = `다시 ${again}개`;
  const pct = total ? Math.round((known/total)*100) : 0;
  $("#bar").style.width = `${pct}%`;
  $("#pctChip").textContent = `${pct}%`;
}

/* -------------------- Tabs -------------------- */
let currentTab = "vocab";
function currentItems(){
  if(currentTab==="vocab") return DATA.vocab;
  if(currentTab==="expr") return DATA.expr;
  if(currentTab==="gram") return DATA.gram;
  return [];
}
$("#tabs").addEventListener("click", (e)=>{
  const btn = e.target.closest(".tab");
  if(!btn) return;
  currentTab = btn.dataset.tab;
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  btn.classList.add("active");
  render();
});

/* -------------------- Render Cards -------------------- */
function renderCards(items){
  const langMode = $("#lang").value; // both|vi|ko
  const wrap = el("div",{class:"cards"});
  items.forEach(item=>{
    const mark = getMark(item.id);
    const status = mark==="known" ? "알아요" : (mark==="again" ? "다시" : "미표시");
    const statusClass = mark==="known" ? "status known" : (mark==="again" ? "status again" : "status");

    const card = el("div",{class:"card"});
    card.appendChild(
      el("div",{class:"kterm"},[
        el("div",{class:"term", html: escapeHtml(item.term)}),
        el("span",{class:"tag", html: escapeHtml(item.kind)})
      ])
    );

    // Meaning block (depending on language mode)
    const meaningHtml = (() => {
      if(langMode==="vi"){
        return `<div class="muted"><b>뜻(베트남어)</b>: ${escapeHtml(item.viDef)}</div>
                <div class="muted" style="margin-top:6px"><b>뜻(한국어)</b>: ${escapeHtml(item.koDef)}</div>`;
      }
      if(langMode==="ko"){
        return `<div class="muted"><b>뜻(한국어)</b>: ${escapeHtml(item.koDef)}</div>
                <div class="muted" style="margin-top:6px"><b>뜻(베트남어)</b>: ${escapeHtml(item.viDef)}</div>`;
      }
      return `<div class="muted"><b>뜻(한국어)</b>: ${escapeHtml(item.koDef)}</div>
              <div class="muted" style="margin-top:6px"><b>뜻(베트남어)</b>: ${escapeHtml(item.viDef)}</div>`;
    })();

    card.appendChild(el("details",{},[
      el("summary",{html:"뜻/설명 보기"}),
      el("div",{html: meaningHtml})
    ]));

    card.appendChild(el("details",{},[
      el("summary",{html:"예문 보기"}),
      el("div",{class:"ex", html: `<b>KR</b>: ${escapeHtml(item.koEx)}<br/><b>VI</b>: ${escapeHtml(item.viEx)}`})
    ]));

    // Actions
    const actions = el("div",{class:"actions"});
    actions.appendChild(el("button",{class:"btn small ok", onClick:()=>setMark(item.id,"known")},[document.createTextNode("알아요")]));
    actions.appendChild(el("button",{class:"btn small bad", onClick:()=>setMark(item.id,"again")},[document.createTextNode("다시")]));
    actions.appendChild(el("button",{class:"btn small ghost", onClick:()=>setMark(item.id,"none")},[documen]()
