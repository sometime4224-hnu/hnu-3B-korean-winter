<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>'Në§Œí•˜ë‹¤' í¬ê¸° ë¹„êµ ê²Œì„</title>
    <style>
        :root {
            --primary-color: #5D9CEC;
            --success-color: #48CFAD;
            --warning-color: #FFCE54;
            --bg-color: #F5F7FA;
            --zone-border: #AAB2BD;
            --zone-active: #4A89DC;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            /* ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ ëŒ€ì‘ */
            height: 100dvh; 
            overflow: hidden;
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
        }

        #game-container {
            width: 100%;
            height: 100%;
            max-width: 800px; /* íƒœë¸”ë¦¿/PCì—ì„œëŠ” ë„ˆë¬´ ë„“ì–´ì§€ì§€ ì•Šê²Œ */
            margin: 0 auto;
            background: white;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* ë‘¥ê·¼ ëª¨ì„œë¦¬ëŠ” PCí™”ë©´(ë„ˆë¹„ 800px ì´ìƒ)ì—ì„œë§Œ ì ìš© */
        @media (min-width: 801px) {
            body {
                padding: 2vh 0;
                align-items: center;
                justify-content: center;
                display: flex;
            }
            #game-container {
                height: 96vh;
                border-radius: 24px;
                overflow: hidden;
            }
        }

        /* --- Header --- */
        header {
            padding: 12px 16px;
            padding-top: max(12px, env(safe-area-inset-top)); /* ë…¸ì¹˜ ëŒ€ì‘ */
            background: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0; /* í¬ê¸° ì¤„ì–´ë“¤ì§€ ì•ŠìŒ */
            z-index: 10;
        }

        h1 { margin: 0; font-size: 1.1rem; }
        .level-indicator { font-weight: bold; font-size: 0.95rem; }

        /* --- Question Area --- */
        .question-area {
            padding: 12px 16px;
            text-align: center;
            background: #E8F0FE;
            border-bottom: 1px solid #D2E3FC;
            flex-shrink: 0;
            z-index: 5;
        }

        .sentence {
            font-size: clamp(1.1rem, 4vw, 1.4rem); /* í™”ë©´ í¬ê¸°ì— ë”°ë¼ ê¸€ì í¬ê¸° ì¡°ì ˆ */
            font-weight: bold;
            color: #333;
            margin-bottom: 6px;
            word-break: keep-all;
            line-height: 1.3;
        }

        .instruction {
            font-size: 0.85rem;
            color: #555;
            word-break: keep-all;
        }

        /* --- Play Area (Scrollable) --- */
        #play-area {
            flex: 1; /* ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì°¨ì§€ */
            position: relative;
            background-color: #fff;
            padding: 16px;
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2ì—´ */
            grid-auto-rows: minmax(90px, auto); /* ìµœì†Œ ë†’ì´ ë³´ì¥ */
            gap: 12px;
            overflow-y: auto; /* ë‚´ë¶€ ìŠ¤í¬ë¡¤ */
            align-content: start;
            -webkit-overflow-scrolling: touch;
        }

        /* ì•„ì£¼ ì‘ì€ í™”ë©´ ëŒ€ì‘ (ì•„ì´í° SE ë“±) */
        @media (max-width: 360px) {
            #play-area {
                grid-template-columns: 1fr; /* 1ì—´ë¡œ ë³€ê²½ */
                padding: 10px;
                gap: 10px;
            }
        }

        /* --- Items --- */
        .reference-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-radius: 12px;
            background: #fafafa;
            border: 1px solid #eee;
        }

        .ref-object-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 70px;
            flex-shrink: 0;
            margin-right: 8px;
        }

        .object-emoji {
            font-size: 2.2rem;
            line-height: 1;
            margin-bottom: 4px;
        }

        .object-label {
            font-size: 0.75rem;
            font-weight: bold;
            color: #666;
            background: rgba(0,0,0,0.05);
            padding: 2px 6px;
            border-radius: 6px;
            white-space: nowrap;
        }

        /* Drop Zone */
        .drop-zone {
            flex: 1;
            height: 100%;
            min-height: 70px;
            border: 2px dashed var(--zone-border);
            border-radius: 10px;
            background-color: #f8fbff;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            transition: background-color 0.2s;
        }

        .drop-zone::after {
            content: "ì—¬ê¸°";
            color: #cbd5e0;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .drop-zone.active {
            border-color: var(--zone-active);
            background-color: #eef6ff;
        }

        /* --- Draggable Target --- */
        #draggable-target {
            position: absolute; /* Play Areaê°€ ì•„ë‹Œ ì „ì²´ ì»¨í…Œì´ë„ˆ ê¸°ì¤€ */
            display: none; 
            flex-direction: column;
            align-items: center;
            cursor: grab;
            z-index: 1000;
            padding: 8px;
            background: rgba(255,255,255,0.9);
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            /* í„°ì¹˜ ì˜ì—­ í™•ë³´ */
            min-width: 60px;
            min-height: 60px;
            justify-content: center;
        }

        #draggable-target:active {
            cursor: grabbing;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            transform: scale(1.1) !important; /* ë“œë˜ê·¸ ì‹œ ì‚´ì§ ì»¤ì§ */
        }
        
        #draggable-target .object-emoji {
            font-size: 3rem;
            margin: 0;
        }

        /* --- Controls (Fixed Bottom) --- */
        .controls {
            padding: 12px 16px;
            padding-bottom: max(12px, env(safe-area-inset-bottom)); /* í•˜ë‹¨ ë°” ëŒ€ì‘ */
            background: #fff;
            border-top: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
            z-index: 20;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .slider-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f1f3f5;
            padding: 8px 12px;
            border-radius: 24px;
        }

        .label-text {
            font-size: 0.8rem;
            white-space: nowrap;
        }

        input[type=range] {
            width: 100%;
            height: 6px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
            -webkit-appearance: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        button#check-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 24px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px 0 #37BC9B;
            white-space: nowrap;
            min-width: 70px;
        }

        button#check-btn:active {
            transform: translateY(3px);
            box-shadow: none;
        }

        /* --- Modals --- */
        .modal {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 20px;
            width: 100%;
            max-width: 320px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal h2 { margin: 8px 0; font-size: 1.3rem; }
        .modal p { font-size: 1rem; margin: 16px 0 24px; line-height: 1.5; word-break: keep-all; }
        
        .modal button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 0;
            width: 100%;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
        }

        .status-icon { font-size: 3.5rem; display: block; margin-bottom: 8px; }
        .highlight { color: #E74C3C; }
        .highlight-blue { color: #2980B9; }

    </style>
</head>
<body>

<div id="game-container">
    <header>
        <h1>'Në§Œí•˜ë‹¤' ë¬¸ë²• ê²Œì„</h1>
        <div class="level-indicator">ë¬¸ì œ <span id="current-level">1</span> / 6</div>
    </header>

    <div class="question-area">
        <div class="sentence" id="sentence-text">ë¡œë”© ì¤‘...</div>
        <div class="instruction">ì´ëª¨ì§€ë¥¼ <strong>ë„¤ëª¨ ì¹¸</strong>ì— ëŒì–´ë‹¤ ë†“ê³  í¬ê¸°ë¥¼ ë§ì¶”ì„¸ìš”!</div>
    </div>

    <div id="play-area">
        <!-- JSë¡œ ë‚´ìš© ì±„ì›€ -->
    </div>

    <!-- ë“œë˜ê·¸ ëŒ€ìƒ (í”Œë¡œíŒ…) -->
    <div id="draggable-target">
        <div class="object-emoji" id="target-emoji">â“</div>
        <div class="object-label" id="target-label">ëŒ€ìƒ</div>
    </div>

    <div class="controls">
        <div class="slider-container">
            <span class="label-text">ì‘ê²Œ</span>
            <input type="range" id="size-slider" min="0.4" max="2.6" step="0.1" value="1">
            <span class="label-text">í¬ê²Œ</span>
        </div>
        <button id="check-btn">í™•ì¸</button>
    </div>

    <!-- í”¼ë“œë°± ëª¨ë‹¬ -->
    <div id="modal-feedback" class="modal">
        <div class="modal-content">
            <span id="modal-icon" class="status-icon"></span>
            <h2 id="modal-title">ê²°ê³¼</h2>
            <p id="modal-msg">ë©”ì‹œì§€</p>
            <button id="next-btn">ë‹¤ìŒ ë¬¸ì œ</button>
        </div>
    </div>
    
    <!-- í´ë¦¬ì–´ ëª¨ë‹¬ -->
    <div id="modal-clear" class="modal">
        <div class="modal-content">
            <span class="status-icon">ğŸ†</span>
            <h2 style="color:var(--success-color)">ì°¸ ì˜í–ˆì–´ìš”!</h2>
            <p>'Në§Œí•˜ë‹¤' ë¬¸ë²•ì„<br>ëª¨ë‘ ë§ˆìŠ¤í„°í–ˆìŠµë‹ˆë‹¤!</p>
            <button onclick="location.reload()">ì²˜ìŒë¶€í„° ë‹¤ì‹œ</button>
        </div>
    </div>
</div>

<script>
    // ê²Œì„ ë°ì´í„°
    const levels = [
        {
            sentence: "<span class='highlight'>ëˆˆì‚¬ëŒ</span>ì´ <span class='highlight-blue'>ì‚¬ëŒ</span>ë§Œ í•´ìš”.",
            target: { emoji: "â˜ƒï¸", label: "ëˆˆì‚¬ëŒ" },
            references: [
                { emoji: "ğŸ ", label: "ì§‘", scale: 2.5, isCorrect: false },
                { emoji: "ğŸ§‘", label: "ì‚¬ëŒ", scale: 1.2, isCorrect: true },
                { emoji: "ğŸœ", label: "ê°œë¯¸", scale: 0.5, isCorrect: false },
                { emoji: "ğŸŒ³", label: "ë‚˜ë¬´", scale: 2.0, isCorrect: false }
            ],
            targetStartScale: 0.6,
            msgCorrect: "ì •ë‹µ! ëˆˆì‚¬ëŒì´ ì‚¬ëŒë§Œí¼ í¬ë„¤ìš”.",
            msgWrongObj: "ë¹„êµ ëŒ€ìƒì´ í‹€ë ¸ì–´ìš”.<br>ì‚¬ëŒ ì˜†ì— ë†“ì•„ë³´ì„¸ìš”.",
            msgWrongSize: "í¬ê¸°ê°€ ë‹¬ë¼ìš”. ì‚¬ëŒê³¼ ë¹„ìŠ·í•˜ê²Œ ë§ì¶°ì£¼ì„¸ìš”."
        },
        {
            sentence: "<span class='highlight'>ë¬¼ê³ ê¸°</span>ê°€ <span class='highlight-blue'>íŒ”ëš</span>ë§Œ í•´ìš”.",
            target: { emoji: "ğŸŸ", label: "ë¬¼ê³ ê¸°" },
            references: [
                { emoji: "ğŸ’", label: "ë°˜ì§€", scale: 0.4, isCorrect: false },
                { emoji: "ğŸ’ª", label: "íŒ”ëš", scale: 1.0, isCorrect: true },
                { emoji: "ğŸ³", label: "ê³ ë˜", scale: 2.5, isCorrect: false },
                { emoji: "ğŸ‘Ÿ", label: "ì‹ ë°œ", scale: 0.7, isCorrect: false }
            ],
            targetStartScale: 2.0,
            msgCorrect: "ì™€! íŒ”ëšë§Œí•œ ë¬¼ê³ ê¸°ë„¤ìš”!",
            msgWrongObj: "ë¬¼ê³ ê¸°ê°€ 'íŒ”ëš'ë§Œí•˜ë‹¤ê³  í–ˆì–´ìš”.<br>íŒ”ëš ê·¸ë¦¼ ì˜†ì— ë†“ì•„ë³´ì„¸ìš”.",
            msgWrongSize: "í¬ê¸°ê°€ ì•ˆ ë§ì•„ìš”. íŒ”ëš í¬ê¸°ë‘ ë¹„ìŠ·í•˜ê²Œ í•´ë³¼ê¹Œìš”?"
        },
        {
            sentence: "<span class='highlight'>ê³ êµ¬ë§ˆ</span>ê°€ <span class='highlight-blue'>ì–¼êµ´</span>ë§Œ í•´ìš”.",
            target: { emoji: "ğŸ ", label: "ê³ êµ¬ë§ˆ" },
            references: [
                { emoji: "ğŸ¬", label: "ì‚¬íƒ•", scale: 0.3, isCorrect: false },
                { emoji: "ğŸ˜Š", label: "ì–¼êµ´", scale: 1.3, isCorrect: true },
                { emoji: "ğŸš—", label: "ìë™ì°¨", scale: 2.5, isCorrect: false },
                { emoji: "ğŸ¥œ", label: "ë•…ì½©", scale: 0.4, isCorrect: false }
            ],
            targetStartScale: 0.5,
            msgCorrect: "ì •ë‹µ! ì–¼êµ´ë§Œí¼ í° ê³ êµ¬ë§ˆì˜ˆìš”.",
            msgWrongObj: "'ì–¼êµ´' ì˜† ë¹ˆì¹¸ì— ë†“ì•„ë³´ì„¸ìš”.",
            msgWrongSize: "ê³ êµ¬ë§ˆê°€ ë„ˆë¬´ ì‘ê±°ë‚˜ ì»¤ìš”.<br>ì–¼êµ´ í¬ê¸°ë§Œí¼ ë§ì¶°ì£¼ì„¸ìš”."
        },
        {
            sentence: "ì œ <span class='highlight'>ì–¼êµ´</span>ì€ <span class='highlight-blue'>ì£¼ë¨¹</span>ë§Œ í•´ìš”.",
            target: { emoji: "ğŸ‘±â€â™€ï¸", label: "ë‚´ ì–¼êµ´" },
            references: [
                { emoji: "ğŸ‘Š", label: "ì£¼ë¨¹", scale: 0.8, isCorrect: true },
                { emoji: "ğŸ ", label: "ì§‘", scale: 2.2, isCorrect: false },
                { emoji: "ğŸ‰", label: "ìˆ˜ë°•", scale: 1.5, isCorrect: false },
                { emoji: "ğŸœ", label: "ê°œë¯¸", scale: 0.4, isCorrect: false }
            ],
            targetStartScale: 1.8,
            msgCorrect: "ë§ì•„ìš”! ì–¼êµ´ì´ ì£¼ë¨¹ë§Œí¼ ì‘ë„¤ìš”.",
            msgWrongObj: "ì–¼êµ´ì´ 'ì£¼ë¨¹'ë§Œí•˜ë‹¤ê³  í–ˆì–´ìš”.<br>ì£¼ë¨¹ ì˜†ì— ë†“ì•„ë³´ì„¸ìš”.",
            msgWrongSize: "ì•„ì§ ì»¤ìš”! ì£¼ë¨¹ë§Œí¼ ì‘ê²Œ ì¤„ì—¬ì£¼ì„¸ìš”."
        },
        {
            sentence: "ì € <span class='highlight'>ë°°</span>ëŠ” <span class='highlight-blue'>ê³ ë˜</span>ë§Œ í•´ìš”.",
            target: { emoji: "ğŸš¤", label: "ë°°" },
            references: [
                { emoji: "ğŸ¦†", label: "ì˜¤ë¦¬", scale: 0.5, isCorrect: false },
                { emoji: "ğŸ‹", label: "ê³ ë˜", scale: 2.0, isCorrect: true },
                { emoji: "ğŸ”ï¸", label: "ì‚°", scale: 3.0, isCorrect: false },
                { emoji: "ğŸŠ", label: "ìˆ˜ì˜ì„ ìˆ˜", scale: 0.8, isCorrect: false }
            ],
            targetStartScale: 0.8,
            msgCorrect: "ë”©ë™ëŒ•! ë°°ê°€ ê³ ë˜ì²˜ëŸ¼ í¬êµ°ìš”.",
            msgWrongObj: "'ê³ ë˜' ì˜† ë¹ˆì¹¸ì— ë†“ì•„ë³´ì„¸ìš”.",
            msgWrongSize: "í¬ê¸°ê°€ ë‹¬ë¼ìš”. ê³ ë˜ë§Œí¼ í¬ê²Œ ë§Œë“¤ì–´ì£¼ì„¸ìš”."
        },
        {
            sentence: "ì´ <span class='highlight'>íœ´ëŒ€í°</span>ì€ <span class='highlight-blue'>í•™ìƒì¦</span>ë§Œ í•´ìš”.",
            target: { emoji: "ğŸ“±", label: "íœ´ëŒ€í°" },
            references: [
                { emoji: "ğŸ“º", label: "TV", scale: 2.5, isCorrect: false },
                { emoji: "ğŸ’»", label: "ë…¸íŠ¸ë¶", scale: 1.8, isCorrect: false },
                { emoji: "ğŸ’³", label: "í•™ìƒì¦", scale: 0.8, isCorrect: true },
                { emoji: "ğŸ’", label: "ê°€ë°©", scale: 1.5, isCorrect: false }
            ],
            targetStartScale: 1.8,
            msgCorrect: "ì •ë‹µ! í•™ìƒì¦ í¬ê¸°ì˜ ì•„ì£¼ ì‘ì€ íœ´ëŒ€í°ì´ë„¤ìš”.",
            msgWrongObj: "'í•™ìƒì¦' ì˜†ì— ë†“ì•„ë³´ì„¸ìš”.",
            msgWrongSize: "ë„ˆë¬´ ì»¤ìš”! í•™ìƒì¦ë§Œí¼ ì‘ê²Œ ì¤„ì—¬ì£¼ì„¸ìš”."
        }
    ];

    let currentLevelIdx = 0;
    let currentScale = 1.0;
    let isDragging = false;
    let dragOffsetX = 0;
    let dragOffsetY = 0;

    function initGame() {
        const slider = document.getElementById('size-slider');
        const checkBtn = document.getElementById('check-btn');
        const nextBtn = document.getElementById('next-btn');
        const targetEl = document.getElementById('draggable-target');

        slider.addEventListener('input', updateTargetSize);
        checkBtn.addEventListener('click', checkAnswer);
        nextBtn.addEventListener('click', nextLevel);
        
        targetEl.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', dragMove);
        document.addEventListener('mouseup', dragEnd);

        targetEl.addEventListener('touchstart', dragStart, {passive: false});
        document.addEventListener('touchmove', dragMove, {passive: false});
        document.addEventListener('touchend', dragEnd);

        loadLevel(0);
        
        // í™”ë©´ ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ìœ„ì¹˜ ì¬ì¡°ì • (ì„ íƒ ì‚¬í•­)
        window.addEventListener('resize', () => {
             // ë¦¬ì‚¬ì´ì¦ˆ ì‹œ íƒ€ê²Ÿì´ í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šê²Œ ê°„ë‹¨í•œ ì¡°ì¹˜
             resetTargetPosition();
        });
    }

    function loadLevel(idx) {
        currentLevelIdx = idx;
        const level = levels[idx];
        
        document.getElementById('current-level').textContent = idx + 1;
        document.getElementById('sentence-text').innerHTML = level.sentence;
        
        const targetEl = document.getElementById('draggable-target');
        const targetEmoji = document.getElementById('target-emoji');
        const targetLabel = document.getElementById('target-label');
        const slider = document.getElementById('size-slider');

        targetEmoji.textContent = level.target.emoji;
        targetLabel.textContent = level.target.label;
        currentScale = level.targetStartScale;
        slider.value = currentScale;
        
        targetEl.style.display = 'flex';
        // transformì—ëŠ” scaleë§Œ ì ìš©. ìœ„ì¹˜ëŠ” top/leftë¡œ ì œì–´
        targetEl.style.transform = `scale(${currentScale})`;
        
        // ê·¸ë¦¬ë“œ ìƒì„±
        const playArea = document.getElementById('play-area');
        playArea.innerHTML = '';
        
        level.references.forEach((ref, i) => {
            const item = document.createElement('div');
            item.className = 'reference-item';
            
            const refWrapper = document.createElement('div');
            refWrapper.className = 'ref-object-wrapper';
            
            const emoji = document.createElement('div');
            emoji.className = 'object-emoji';
            emoji.textContent = ref.emoji;
            emoji.style.transform = `scale(${ref.scale})`;
            
            const label = document.createElement('div');
            label.className = 'object-label';
            label.textContent = ref.label;

            refWrapper.appendChild(emoji);
            refWrapper.appendChild(label);

            const zone = document.createElement('div');
            zone.className = 'drop-zone';
            zone.dataset.index = i;
            zone.dataset.correct = ref.isCorrect;

            item.appendChild(refWrapper);
            item.appendChild(zone);
            playArea.appendChild(item);
        });

        // ìœ„ì¹˜ ì´ˆê¸°í™”: í™”ë©´ ë Œë”ë§ í›„ ì‹¤í–‰
        setTimeout(resetTargetPosition, 50);
    }

    function resetTargetPosition() {
        const targetEl = document.getElementById('draggable-target');
        const container = document.getElementById('game-container');
        const controls = document.querySelector('.controls');
        
        if (!container || !targetEl) return;
        
        const cRect = container.getBoundingClientRect();
        // ì»¨íŠ¸ë¡¤ ë°” ë°”ë¡œ ìœ„, ì˜¤ë¥¸ìª½ ì—¬ë°± ì¡°ê¸ˆ
        const controlsHeight = controls ? controls.offsetHeight : 80;
        
        // ì•ˆì „í•˜ê²Œ í™”ë©´ í•˜ë‹¨ 20%, ìš°ì¸¡ 20px ìœ„ì¹˜
        const initX = cRect.width - targetEl.offsetWidth - 20; 
        const initY = cRect.height - controlsHeight - targetEl.offsetHeight - 20;
        
        // ìŒìˆ˜ ì¢Œí‘œ ë°©ì§€
        targetEl.style.left = Math.max(10, initX) + 'px';
        targetEl.style.top = Math.max(10, initY) + 'px';
    }

    function updateTargetSize() {
        const slider = document.getElementById('size-slider');
        const targetEl = document.getElementById('draggable-target');
        currentScale = parseFloat(slider.value);
        targetEl.style.transform = `scale(${currentScale})`;
    }

    /* --- ë“œë˜ê·¸ ë¡œì§ --- */
    function dragStart(e) {
        e.preventDefault();
        isDragging = true;
        
        const targetEl = document.getElementById('draggable-target');
        const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
        
        const tRect = targetEl.getBoundingClientRect();
        const container = document.getElementById('game-container');
        const cRect = container.getBoundingClientRect(); // ì»¨í…Œì´ë„ˆì˜ ì ˆëŒ€ ìœ„ì¹˜

        // íƒ€ê²Ÿ ë‚´ í´ë¦­ ìœ„ì¹˜ (ì˜¤í”„ì…‹)
        dragOffsetX = clientX - tRect.left;
        dragOffsetY = clientY - tRect.top;
        
        targetEl.style.cursor = 'grabbing';
    }

    function dragMove(e) {
        if (!isDragging) return;
        e.preventDefault();

        const targetEl = document.getElementById('draggable-target');
        const container = document.getElementById('game-container');
        const cRect = container.getBoundingClientRect();

        const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

        // ì»¨í…Œì´ë„ˆ ê¸°ì¤€ ìƒëŒ€ ì¢Œí‘œ = (í˜„ì¬ í™”ë©´ ì¢Œí‘œ) - (ì»¨í…Œì´ë„ˆ í™”ë©´ ì¢Œí‘œ) - (ì˜¤í”„ì…‹)
        let newLeft = clientX - cRect.left - dragOffsetX;
        let newTop = clientY - cRect.top - dragOffsetY;

        // ê²½ê³„ ì²´í¬ (í™”ë©´ ë°–ìœ¼ë¡œ ì™„ì „ ì‚¬ë¼ì§ ë°©ì§€)
        const maxLeft = cRect.width - 20;
        const maxTop = cRect.height - 20;
        
        // ìµœì†Œí•œì˜ ì¼ë¶€ëŠ” ë³´ì´ê²Œ (-20 ~ max)
        newLeft = Math.max(-targetEl.offsetWidth + 20, Math.min(newLeft, maxLeft));
        newTop = Math.max(-targetEl.offsetHeight + 20, Math.min(newTop, maxTop));

        targetEl.style.left = newLeft + 'px';
        targetEl.style.top = newTop + 'px';

        checkDropZone(clientX, clientY);
    }

    function dragEnd() {
        isDragging = false;
        document.getElementById('draggable-target').style.cursor = 'grab';
        document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('active'));
    }

    function checkDropZone(x, y) {
        // ë“œë¡­ì¡´ í•˜ì´ë¼ì´íŠ¸ (ì‹œê°ì  í”¼ë“œë°±)
        // íƒ€ê²Ÿ ì¤‘ì‹¬ ì¢Œí‘œ ê³„ì‚°
        const targetEl = document.getElementById('draggable-target');
        const tRect = targetEl.getBoundingClientRect();
        const cx = tRect.left + tRect.width/2;
        const cy = tRect.top + tRect.height/2;

        document.querySelectorAll('.drop-zone').forEach(zone => {
            const zRect = zone.getBoundingClientRect();
            // ì¤‘ì‹¬ì ì´ ì¡´ ì•ˆì— ë“¤ì–´ì™”ëŠ”ì§€ í™•ì¸
            if (cx >= zRect.left && cx <= zRect.right && cy >= zRect.top && cy <= zRect.bottom) {
                zone.classList.add('active');
            } else {
                zone.classList.remove('active');
            }
        });
    }

    /* --- ì •ë‹µ í™•ì¸ --- */
    function checkAnswer() {
        const level = levels[currentLevelIdx];
        const targetEl = document.getElementById('draggable-target');
        const tRect = targetEl.getBoundingClientRect();
        const cx = tRect.left + tRect.width/2;
        const cy = tRect.top + tRect.height/2;
        
        let droppedZone = null;

        document.querySelectorAll('.drop-zone').forEach(zone => {
            const zRect = zone.getBoundingClientRect();
            if (cx >= zRect.left && cx <= zRect.right && cy >= zRect.top && cy <= zRect.bottom) {
                droppedZone = zone;
            }
        });

        if (!droppedZone) {
            showModal(false, "ë¬¼ê±´ì„ <strong>ë„¤ëª¨ ì¹¸ ì•ˆ</strong>ì— ë„£ì–´ì£¼ì„¸ìš”!");
            return;
        }

        const isPosCorrect = droppedZone.dataset.correct === "true";
        if (!isPosCorrect) {
            showModal(false, level.msgWrongObj);
            return;
        }

        const correctRefData = level.references.find(r => r.isCorrect);
        const sizeDiff = Math.abs(currentScale - correctRefData.scale);
        
        // ì˜¤ì°¨ ë²”ìœ„ 0.45
        if (sizeDiff <= 0.45) {
            showModal(true, level.msgCorrect);
        } else {
            showModal(false, level.msgWrongSize);
        }
    }

    function nextLevel() {
        document.getElementById('modal-feedback').style.display = 'none';
        
        if (currentLevelIdx < levels.length - 1) {
            loadLevel(currentLevelIdx + 1);
        } else {
            document.getElementById('modal-clear').style.display = 'flex';
        }
    }

    function showModal(isSuccess, msg) {
        const modal = document.getElementById('modal-feedback');
        const titleEl = document.getElementById('modal-title');
        const msgEl = document.getElementById('modal-msg');
        const iconEl = document.getElementById('modal-icon');
        const nextBtn = document.getElementById('next-btn');

        modal.style.display = 'flex';
        msgEl.innerHTML = msg;

        if (isSuccess) {
            titleEl.textContent = "ì •ë‹µ!";
            titleEl.style.color = "var(--success-color)";
            iconEl.textContent = "â­•";
            iconEl.className = "status-icon";
            
            if (currentLevelIdx >= levels.length - 1) {
                nextBtn.textContent = "ê²°ê³¼ ë³´ê¸°";
            } else {
                nextBtn.textContent = "ë‹¤ìŒ ë¬¸ì œ";
            }
            nextBtn.onclick = nextLevel;
        } else {
            titleEl.textContent = "ë‹¤ì‹œ í•´ë³¼ê¹Œìš”?";
            titleEl.style.color = "#E74C3C";
            iconEl.textContent = "âŒ";
            iconEl.className = "status-icon";
            nextBtn.textContent = "ë‹«ê¸°";
            nextBtn.onclick = () => { modal.style.display = 'none'; };
        }
    }

    window.onload = initGame;
</script>
</body>
</html>

