<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>'Në§Œí•˜ë‹¤' í¬ê¸° ë¹„êµ ê²Œì„</title>
    <style>
        :root {
            --primary-color: #5D9CEC;
            --success-color: #48CFAD;
            --warning-color: #FFCE54;
            --bg-color: #F5F7FA;
            --zone-border: #AAB2BD;
            --zone-active: #4A89DC;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        #game-container {
            width: 100%;
            max-width: 800px;
            height: 100%;
            max-height: 900px;
            background: white;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* ë‘¥ê·¼ ëª¨ì„œë¦¬ëŠ” PCí™”ë©´ì—ì„œë§Œ ì ìš© */
        @media (min-width: 801px) {
            #game-container {
                height: 95vh;
                border-radius: 20px;
            }
        }

        /* Header */
        header {
            padding: 15px 20px;
            background: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        h1 { margin: 0; font-size: 1.2rem; }
        .level-indicator { font-weight: bold; font-size: 1rem; }

        /* Question Area */
        .question-area {
            padding: 15px 20px;
            text-align: center;
            background: #E8F0FE;
            border-bottom: 2px solid #D2E3FC;
            flex-shrink: 0;
        }

        .sentence {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            word-break: keep-all;
        }

        .instruction {
            font-size: 0.95rem;
            color: #555;
        }

        /* Play Area - Grid Layout */
        #play-area {
            flex: 1;
            position: relative;
            background-color: #fff;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-auto-rows: minmax(100px, 120px);
            gap: 15px;
            overflow-y: auto;
            align-content: start;
        }

        @media (max-width: 600px) {
            #play-area {
                grid-template-columns: 1fr; /* ëª¨ë°”ì¼ 1ì—´ */
                gap: 10px;
                padding: 10px;
            }
            .sentence { font-size: 1.2rem; }
        }

        /* Reference Item Card */
        .reference-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            border-radius: 15px;
            background: #fafafa;
            border: 1px solid #eee;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }

        .ref-object-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 80px;
            flex-shrink: 0;
            margin-right: 10px;
        }

        .object-emoji {
            font-size: 2.5rem;
            line-height: 1;
            margin-bottom: 5px;
            transform-origin: center center;
            transition: transform 0.2s;
        }

        .object-label {
            font-size: 0.85rem;
            font-weight: bold;
            color: #666;
            background: rgba(0,0,0,0.05);
            padding: 2px 8px;
            border-radius: 8px;
            white-space: nowrap;
        }

        /* Drop Zone */
        .drop-zone {
            flex: 1;
            height: 100%;
            min-height: 80px;
            border: 2px dashed var(--zone-border);
            border-radius: 12px;
            background-color: #f8fbff;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            transition: all 0.2s ease;
        }

        .drop-zone::after {
            content: "ì—¬ê¸°";
            color: #cbd5e0;
            font-size: 0.9rem;
            font-weight: bold;
            pointer-events: none;
        }

        .drop-zone.active {
            border-color: var(--zone-active);
            background-color: #eef6ff;
            transform: scale(1.02);
            box-shadow: 0 0 10px rgba(74, 137, 220, 0.2);
        }

        .drop-zone.active::after {
            color: var(--zone-active);
            content: "ë†“ìœ¼ì„¸ìš”!";
        }

        /* Draggable Target */
        #draggable-target {
            position: absolute;
            display: none; /* JS ë¡œë”© í›„ í‘œì‹œ */
            flex-direction: column;
            align-items: center;
            cursor: grab;
            z-index: 1000;
            /* ì´ˆê¸° ìœ„ì¹˜ëŠ” JSë¡œ ì œì–´ */
            padding: 10px;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(2px);
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 2px solid white;
            transition: transform 0.1s; /* ë¶€ë“œëŸ¬ìš´ í¬ê¸° ë³€í™” */
        }

        #draggable-target:active {
            cursor: grabbing;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        #draggable-target .object-emoji {
            font-size: 3.5rem;
        }

        /* Controls */
        .controls {
            padding: 15px 20px;
            background: #fff;
            border-top: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
            z-index: 1001;
        }

        .slider-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f1f3f5;
            padding: 10px 15px;
            border-radius: 30px;
        }

        input[type=range] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
            -webkit-appearance: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        button#check-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #37BC9B;
            transition: transform 0.1s;
            white-space: nowrap;
        }

        button#check-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        /* Modals */
        .modal {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 85%;
            max-width: 360px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes modalPop {
            from { transform: scale(0.7); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal h2 { margin: 10px 0; font-size: 1.5rem; }
        .modal p { font-size: 1.1rem; color: #555; margin: 20px 0; line-height: 1.5; }
        
        .modal button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
        }

        .status-icon { font-size: 4rem; display: block; margin-bottom: 15px; }
        .highlight { color: #E74C3C; }
        .highlight-blue { color: #2980B9; }

    </style>
</head>
<body>

<div id="game-container">
    <header>
        <h1>'Në§Œí•˜ë‹¤' ë¬¸ë²• ê²Œì„</h1>
        <div class="level-indicator">ë¬¸ì œ <span id="current-level">1</span> / 6</div>
    </header>

    <div class="question-area">
        <div class="sentence" id="sentence-text">ë¡œë”© ì¤‘...</div>
        <div class="instruction">ì´ëª¨ì§€ë¥¼ <strong>ë„¤ëª¨ ì¹¸</strong>ì— ëŒì–´ë‹¤ ë†“ê³  í¬ê¸°ë¥¼ ë§ì¶°ë³´ì„¸ìš”!</div>
    </div>

    <div id="play-area">
        <!-- JSë¡œ ë‚´ìš© ì±„ì›€ -->
    </div>

    <!-- ë“œë˜ê·¸ ëŒ€ìƒ -->
    <div id="draggable-target">
        <div class="object-emoji" id="target-emoji">â“</div>
        <div class="object-label" id="target-label">ëŒ€ìƒ</div>
    </div>

    <div class="controls">
        <div class="slider-container">
            <span style="font-size:0.9rem">ì‘ê²Œ</span>
            <input type="range" id="size-slider" min="0.4" max="2.6" step="0.1" value="1">
            <span style="font-size:0.9rem">í¬ê²Œ</span>
        </div>
        <button id="check-btn">í™•ì¸</button>
    </div>

    <!-- í”¼ë“œë°± ëª¨ë‹¬ -->
    <div id="modal-feedback" class="modal">
        <div class="modal-content">
            <span id="modal-icon" class="status-icon"></span>
            <h2 id="modal-title">ê²°ê³¼</h2>
            <p id="modal-msg">ë©”ì‹œì§€</p>
            <button id="next-btn">ë‹¤ìŒ ë¬¸ì œ</button>
        </div>
    </div>
    
    <!-- í´ë¦¬ì–´ ëª¨ë‹¬ -->
    <div id="modal-clear" class="modal">
        <div class="modal-content">
            <span class="status-icon">ğŸ†</span>
            <h2 style="color:var(--success-color)">ì°¸ ì˜í–ˆì–´ìš”!</h2>
            <p>'Në§Œí•˜ë‹¤' ë¬¸ë²•ì„<br>ëª¨ë‘ ë§ˆìŠ¤í„°í–ˆìŠµë‹ˆë‹¤!</p>
            <button onclick="location.reload()">ì²˜ìŒë¶€í„° ë‹¤ì‹œ</button>
        </div>
    </div>
</div>

<script>
    // ê²Œì„ ë°ì´í„°
    const levels = [
        {
            sentence: "<span class='highlight'>ëˆˆì‚¬ëŒ</span>ì´ <span class='highlight-blue'>ì‚¬ëŒ</span>ë§Œ í•´ìš”.",
            target: { emoji: "â˜ƒï¸", label: "ëˆˆì‚¬ëŒ" },
            references: [
                { emoji: "ğŸ ", label: "ì§‘", scale: 2.5, isCorrect: false },
                { emoji: "ğŸ§‘", label: "ì‚¬ëŒ", scale: 1.2, isCorrect: true },
                { emoji: "ğŸœ", label: "ê°œë¯¸", scale: 0.5, isCorrect: false },
                { emoji: "ğŸŒ³", label: "ë‚˜ë¬´", scale: 2.0, isCorrect: false }
            ],
            targetStartScale: 0.6,
            msgCorrect: "ì •ë‹µ! ëˆˆì‚¬ëŒì´ ì‚¬ëŒë§Œí¼ í¬ë„¤ìš”.",
            msgWrongObj: "ë¹„êµ ëŒ€ìƒì´ í‹€ë ¸ì–´ìš”.<br>ì‚¬ëŒ ì˜†ì— ë†“ì•„ë³´ì„¸ìš”.",
            msgWrongSize: "í¬ê¸°ê°€ ë‹¬ë¼ìš”. ì‚¬ëŒê³¼ ë¹„ìŠ·í•˜ê²Œ ë§ì¶°ì£¼ì„¸ìš”."
        },
        {
            sentence: "<span class='highlight'>ë¬¼ê³ ê¸°</span>ê°€ <span class='highlight-blue'>íŒ”ëš</span>ë§Œ í•´ìš”.",
            target: { emoji: "ğŸŸ", label: "ë¬¼ê³ ê¸°" },
            references: [
                { emoji: "ğŸ’", label: "ë°˜ì§€", scale: 0.4, isCorrect: false },
                { emoji: "ğŸ’ª", label: "íŒ”ëš", scale: 1.0, isCorrect: true },
                { emoji: "ğŸ³", label: "ê³ ë˜", scale: 2.5, isCorrect: false },
                { emoji: "ğŸ‘Ÿ", label: "ì‹ ë°œ", scale: 0.7, isCorrect: false }
            ],
            targetStartScale: 2.0,
            msgCorrect: "ì™€! íŒ”ëšë§Œí•œ ë¬¼ê³ ê¸°ë„¤ìš”!",
            msgWrongObj: "ë¬¼ê³ ê¸°ê°€ 'íŒ”ëš'ë§Œí•˜ë‹¤ê³  í–ˆì–´ìš”.<br>íŒ”ëš ê·¸ë¦¼ ì˜†ì— ë†“ì•„ë³´ì„¸ìš”.",
            msgWrongSize: "í¬ê¸°ê°€ ì•ˆ ë§ì•„ìš”. íŒ”ëš í¬ê¸°ë‘ ë¹„ìŠ·í•˜ê²Œ í•´ë³¼ê¹Œìš”?"
        },
        {
            sentence: "<span class='highlight'>ê³ êµ¬ë§ˆ</span>ê°€ <span class='highlight-blue'>ì–¼êµ´</span>ë§Œ í•´ìš”.",
            target: { emoji: "ğŸ ", label: "ê³ êµ¬ë§ˆ" },
            references: [
                { emoji: "ğŸ¬", label: "ì‚¬íƒ•", scale: 0.3, isCorrect: false },
                { emoji: "ğŸ˜Š", label: "ì–¼êµ´", scale: 1.3, isCorrect: true },
                { emoji: "ğŸš—", label: "ìë™ì°¨", scale: 2.5, isCorrect: false },
                { emoji: "ğŸ¥œ", label: "ë•…ì½©", scale: 0.4, isCorrect: false }
            ],
            targetStartScale: 0.5,
            msgCorrect: "ì •ë‹µ! ì–¼êµ´ë§Œí¼ í° ê³ êµ¬ë§ˆì˜ˆìš”.",
            msgWrongObj: "'ì–¼êµ´' ì˜† ë¹ˆì¹¸ì— ë†“ì•„ë³´ì„¸ìš”.",
            msgWrongSize: "ê³ êµ¬ë§ˆê°€ ë„ˆë¬´ ì‘ê±°ë‚˜ ì»¤ìš”.<br>ì–¼êµ´ í¬ê¸°ë§Œí¼ ë§ì¶°ì£¼ì„¸ìš”."
        },
        {
            sentence: "ì œ <span class='highlight'>ì–¼êµ´</span>ì€ <span class='highlight-blue'>ì£¼ë¨¹</span>ë§Œ í•´ìš”.",
            target: { emoji: "ğŸ‘±â€â™€ï¸", label: "ë‚´ ì–¼êµ´" },
            references: [
                { emoji: "ğŸ‘Š", label: "ì£¼ë¨¹", scale: 0.8, isCorrect: true },
                { emoji: "ğŸ ", label: "ì§‘", scale: 2.2, isCorrect: false },
                { emoji: "ğŸ‰", label: "ìˆ˜ë°•", scale: 1.5, isCorrect: false },
                { emoji: "ğŸœ", label: "ê°œë¯¸", scale: 0.4, isCorrect: false }
            ],
            targetStartScale: 1.8,
            msgCorrect: "ë§ì•„ìš”! ì–¼êµ´ì´ ì£¼ë¨¹ë§Œí¼ ì‘ë„¤ìš”.",
            msgWrongObj: "ì–¼êµ´ì´ 'ì£¼ë¨¹'ë§Œí•˜ë‹¤ê³  í–ˆì–´ìš”.<br>ì£¼ë¨¹ ì˜†ì— ë†“ì•„ë³´ì„¸ìš”.",
            msgWrongSize: "ì•„ì§ ì»¤ìš”! ì£¼ë¨¹ë§Œí¼ ì‘ê²Œ ì¤„ì—¬ì£¼ì„¸ìš”."
        },
        {
            sentence: "ì € <span class='highlight'>ë°°</span>ëŠ” <span class='highlight-blue'>ê³ ë˜</span>ë§Œ í•´ìš”.",
            target: { emoji: "ğŸš¤", label: "ë°°" },
            references: [
                { emoji: "ğŸ¦†", label: "ì˜¤ë¦¬", scale: 0.5, isCorrect: false },
                { emoji: "ğŸ‹", label: "ê³ ë˜", scale: 2.0, isCorrect: true },
                { emoji: "ğŸ”ï¸", label: "ì‚°", scale: 3.0, isCorrect: false },
                { emoji: "ğŸŠ", label: "ìˆ˜ì˜ì„ ìˆ˜", scale: 0.8, isCorrect: false }
            ],
            targetStartScale: 0.8,
            msgCorrect: "ë”©ë™ëŒ•! ë°°ê°€ ê³ ë˜ì²˜ëŸ¼ í¬êµ°ìš”.",
            msgWrongObj: "'ê³ ë˜' ì˜† ë¹ˆì¹¸ì— ë†“ì•„ë³´ì„¸ìš”.",
            msgWrongSize: "í¬ê¸°ê°€ ë‹¬ë¼ìš”. ê³ ë˜ë§Œí¼ í¬ê²Œ ë§Œë“¤ì–´ì£¼ì„¸ìš”."
        },
        {
            sentence: "ì´ <span class='highlight'>íœ´ëŒ€í°</span>ì€ <span class='highlight-blue'>í•™ìƒì¦</span>ë§Œ í•´ìš”.",
            target: { emoji: "ğŸ“±", label: "íœ´ëŒ€í°" },
            references: [
                { emoji: "ğŸ“º", label: "TV", scale: 2.5, isCorrect: false },
                { emoji: "ğŸ’»", label: "ë…¸íŠ¸ë¶", scale: 1.8, isCorrect: false },
                { emoji: "ğŸ’³", label: "í•™ìƒì¦", scale: 0.8, isCorrect: true },
                { emoji: "ğŸ’", label: "ê°€ë°©", scale: 1.5, isCorrect: false }
            ],
            targetStartScale: 1.8,
            msgCorrect: "ì •ë‹µ! í•™ìƒì¦ í¬ê¸°ì˜ ì•„ì£¼ ì‘ì€ íœ´ëŒ€í°ì´ë„¤ìš”.",
            msgWrongObj: "'í•™ìƒì¦' ì˜†ì— ë†“ì•„ë³´ì„¸ìš”.",
            msgWrongSize: "ë„ˆë¬´ ì»¤ìš”! í•™ìƒì¦ë§Œí¼ ì‘ê²Œ ì¤„ì—¬ì£¼ì„¸ìš”."
        }
    ];

    // ìƒíƒœ ë³€ìˆ˜
    let currentLevelIdx = 0;
    let currentScale = 1.0;
    let isDragging = false;
    let dragOffsetX = 0;
    let dragOffsetY = 0;

    // ì´ˆê¸°í™” í•¨ìˆ˜
    function initGame() {
        const slider = document.getElementById('size-slider');
        const checkBtn = document.getElementById('check-btn');
        const nextBtn = document.getElementById('next-btn');
        const targetEl = document.getElementById('draggable-target');

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        // ìŠ¬ë¼ì´ë”
        slider.addEventListener('input', updateTargetSize);
        // ë²„íŠ¼
        checkBtn.addEventListener('click', checkAnswer);
        nextBtn.addEventListener('click', nextLevel);
        
        // ë“œë˜ê·¸ (Mouse)
        targetEl.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', dragMove);
        document.addEventListener('mouseup', dragEnd);

        // ë“œë˜ê·¸ (Touch)
        targetEl.addEventListener('touchstart', dragStart, {passive: false});
        document.addEventListener('touchmove', dragMove, {passive: false});
        document.addEventListener('touchend', dragEnd);

        // ì²« ë ˆë²¨ ë¡œë“œ
        loadLevel(0);
    }

    function loadLevel(idx) {
        currentLevelIdx = idx;
        const level = levels[idx];
        
        // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        document.getElementById('current-level').textContent = idx + 1;
        document.getElementById('sentence-text').innerHTML = level.sentence;
        
        // íƒ€ê²Ÿ ì„¤ì •
        const targetEl = document.getElementById('draggable-target');
        const targetEmoji = document.getElementById('target-emoji');
        const targetLabel = document.getElementById('target-label');
        const slider = document.getElementById('size-slider');

        targetEmoji.textContent = level.target.emoji;
        targetLabel.textContent = level.target.label;
        currentScale = level.targetStartScale;
        slider.value = currentScale;
        
        // ì´ˆê¸° ìœ„ì¹˜ ì„¤ì • (ì»¨í…Œì´ë„ˆ ê¸°ì¤€ ìš°í•˜ë‹¨ ê³ ì •)
        // transformì´ë‚˜ right/bottomì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  ê³„ì‚°ëœ left/top ì‚¬ìš©ì„ ìœ„í•´ ì´ˆê¸°í™”
        targetEl.style.display = 'flex'; // ë³´ì´ê²Œ ì„¤ì •
        targetEl.style.transform = `scale(${currentScale})`;
        
        // ì¤‘ìš”: ìœ„ì¹˜ ì´ˆê¸°í™”ë¥¼ ìœ„í•´ ì ì‹œ ë Œë”ë§ ëŒ€ê¸°
        requestAnimationFrame(() => {
            const container = document.getElementById('game-container');
            const cRect = container.getBoundingClientRect();
            // ì»¨í…Œì´ë„ˆ ì˜¤ë¥¸ìª½ ì•„ë˜ ë°°ì¹˜
            const initX = cRect.width - 100; 
            const initY = cRect.height - 180;
            
            targetEl.style.left = initX + 'px';
            targetEl.style.top = initY + 'px';
        });

        // ê·¸ë¦¬ë“œ ìƒì„±
        const playArea = document.getElementById('play-area');
        playArea.innerHTML = '';
        
        level.references.forEach((ref, i) => {
            const item = document.createElement('div');
            item.className = 'reference-item';
            
            // ë³´ê¸° ì˜ì—­
            const refWrapper = document.createElement('div');
            refWrapper.className = 'ref-object-wrapper';
            
            const emoji = document.createElement('div');
            emoji.className = 'object-emoji';
            emoji.textContent = ref.emoji;
            emoji.style.transform = `scale(${ref.scale})`;
            
            const label = document.createElement('div');
            label.className = 'object-label';
            label.textContent = ref.label;

            refWrapper.appendChild(emoji);
            refWrapper.appendChild(label);

            // ë“œë¡­ ì¡´
            const zone = document.createElement('div');
            zone.className = 'drop-zone';
            zone.dataset.index = i;
            zone.dataset.correct = ref.isCorrect;

            item.appendChild(refWrapper);
            item.appendChild(zone);
            playArea.appendChild(item);
        });
    }

    function updateTargetSize() {
        const slider = document.getElementById('size-slider');
        const targetEl = document.getElementById('draggable-target');
        currentScale = parseFloat(slider.value);
        targetEl.style.transform = `scale(${currentScale})`;
    }

    // --- ë“œë˜ê·¸ ë¡œì§ ---

    function dragStart(e) {
        e.preventDefault();
        isDragging = true;
        
        const targetEl = document.getElementById('draggable-target');
        const container = document.getElementById('game-container');
        
        // ì¢Œí‘œ ì •ê·œí™” (í„°ì¹˜/ë§ˆìš°ìŠ¤)
        const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
        
        const tRect = targetEl.getBoundingClientRect();
        const cRect = container.getBoundingClientRect();

        // íƒ€ê²Ÿ ë‚´ë¶€ì—ì„œì˜ í´ë¦­ ìœ„ì¹˜ ì˜¤í”„ì…‹
        dragOffsetX = clientX - tRect.left;
        dragOffsetY = clientY - tRect.top;

        targetEl.style.cursor = 'grabbing';
    }

    function dragMove(e) {
        if (!isDragging) return;
        e.preventDefault();

        const targetEl = document.getElementById('draggable-target');
        const container = document.getElementById('game-container');
        const cRect = container.getBoundingClientRect();

        const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

        // ì»¨í…Œì´ë„ˆ ê¸°ì¤€ ìƒëŒ€ ì¢Œí‘œ ê³„ì‚°
        // (í˜„ì¬ ë§ˆìš°ìŠ¤ ìœ„ì¹˜) - (ì»¨í…Œì´ë„ˆ ì‹œì‘ ìœ„ì¹˜) - (íƒ€ê²Ÿ ë‚´ë¶€ í´ë¦­ ì˜¤í”„ì…‹)
        let newLeft = clientX - cRect.left - dragOffsetX;
        let newTop = clientY - cRect.top - dragOffsetY;

        // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šê²Œ ì œí•œ (ì„ íƒì‚¬í•­)
        const maxLeft = cRect.width - targetEl.offsetWidth;
        const maxTop = cRect.height - targetEl.offsetHeight;
        
        // ì•½ê°„ì˜ ì—¬ìœ ë¥¼ ë‘ê³  ì œí•œ
        newLeft = Math.max(-20, Math.min(newLeft, maxLeft + 20));
        newTop = Math.max(-20, Math.min(newTop, maxTop + 20));

        targetEl.style.left = newLeft + 'px';
        targetEl.style.top = newTop + 'px';

        // ë“œë¡­ì¡´ í•˜ì´ë¼ì´íŠ¸ ì²´í¬
        checkDropZone(clientX, clientY);
    }

    function dragEnd() {
        isDragging = false;
        const targetEl = document.getElementById('draggable-target');
        targetEl.style.cursor = 'grab';
        
        // í•˜ì´ë¼ì´íŠ¸ ì œê±°
        document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('active'));
    }

    function checkDropZone(x, y) {
        // x, yëŠ” ë·°í¬íŠ¸ ê¸°ì¤€ ì¢Œí‘œ (ë§ˆìš°ìŠ¤/í„°ì¹˜ ìœ„ì¹˜)
        // íƒ€ê²Ÿì˜ ì¤‘ì‹¬ì ì„ ê¸°ì¤€ìœ¼ë¡œ ì²´í¬í•˜ëŠ” ê²ƒì´ ë” ìì—°ìŠ¤ëŸ¬ì›€
        const targetEl = document.getElementById('draggable-target');
        const tRect = targetEl.getBoundingClientRect();
        const centerX = tRect.left + tRect.width / 2;
        const centerY = tRect.top + tRect.height / 2;

        document.querySelectorAll('.drop-zone').forEach(zone => {
            const zRect = zone.getBoundingClientRect();
            if (centerX >= zRect.left && centerX <= zRect.right &&
                centerY >= zRect.top && centerY <= zRect.bottom) {
                zone.classList.add('active');
            } else {
                zone.classList.remove('active');
            }
        });
    }

    // --- ì •ë‹µ í™•ì¸ ë¡œì§ ---

    function checkAnswer() {
        const level = levels[currentLevelIdx];
        const targetEl = document.getElementById('draggable-target');
        const tRect = targetEl.getBoundingClientRect();
        const centerX = tRect.left + tRect.width / 2;
        const centerY = tRect.top + tRect.height / 2;
        
        let droppedZone = null;

        document.querySelectorAll('.drop-zone').forEach(zone => {
            const zRect = zone.getBoundingClientRect();
            if (centerX >= zRect.left && centerX <= zRect.right &&
                centerY >= zRect.top && centerY <= zRect.bottom) {
                droppedZone = zone;
            }
        });

        // 1. ìœ„ì¹˜ ì²´í¬
        if (!droppedZone) {
            showModal(false, "ë¬¼ê±´ì„ <strong>ë„¤ëª¨ ì¹¸ ì•ˆ</strong>ì— ë„£ì–´ì£¼ì„¸ìš”!");
            return;
        }

        const isPosCorrect = droppedZone.dataset.correct === "true";
        if (!isPosCorrect) {
            showModal(false, level.msgWrongObj);
            return;
        }

        // 2. í¬ê¸° ì²´í¬
        const correctRefData = level.references.find(r => r.isCorrect);
        const sizeDiff = Math.abs(currentScale - correctRefData.scale);
        
        // ë‚œì´ë„ ì¡°ì ˆ: ì˜¤ì°¨ ë²”ìœ„ 0.4
        if (sizeDiff <= 0.45) {
            showModal(true, level.msgCorrect);
        } else {
            showModal(false, level.msgWrongSize);
        }
    }

    function nextLevel() {
        const modal = document.getElementById('modal-feedback');
        const clearModal = document.getElementById('modal-clear');
        
        modal.style.display = 'none';
        
        if (currentLevelIdx < levels.length - 1) {
            loadLevel(currentLevelIdx + 1);
        } else {
            clearModal.style.display = 'flex';
        }
    }

    function showModal(isSuccess, msg) {
        const modal = document.getElementById('modal-feedback');
        const titleEl = document.getElementById('modal-title');
        const msgEl = document.getElementById('modal-msg');
        const iconEl = document.getElementById('modal-icon');
        const nextBtn = document.getElementById('next-btn');

        modal.style.display = 'flex';
        msgEl.innerHTML = msg;

        if (isSuccess) {
            titleEl.textContent = "ì •ë‹µì…ë‹ˆë‹¤!";
            titleEl.style.color = "var(--success-color)";
            iconEl.textContent = "â­•";
            iconEl.className = "status-icon";
            
            if (currentLevelIdx >= levels.length - 1) {
                nextBtn.textContent = "ê²°ê³¼ ë³´ê¸°";
            } else {
                nextBtn.textContent = "ë‹¤ìŒ ë¬¸ì œ";
            }
            // ì„±ê³µ ì‹œ ë‹¤ìŒ ë²„íŠ¼ ê¸°ëŠ¥ ì—°ê²°
            nextBtn.onclick = nextLevel;
        } else {
            titleEl.textContent = "ë‹¤ì‹œ ìƒê°í•´ë³´ì„¸ìš”";
            titleEl.style.color = "#E74C3C";
            iconEl.textContent = "âŒ";
            iconEl.className = "status-icon";
            nextBtn.textContent = "ë‹«ê¸°";
            nextBtn.onclick = () => { modal.style.display = 'none'; };
        }
    }

    // ì°½ì´ ì™„ì „íˆ ë¡œë“œëœ í›„ ì‹¤í–‰í•˜ì—¬ ì•ˆì „ì„± í™•ë³´
    window.onload = function() {
        initGame();
    };

</script>
</body>
</html>

