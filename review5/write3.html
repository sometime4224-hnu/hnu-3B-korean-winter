<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>고향 글쓰기 도우미 (KO-VI)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
    
    body { font-family: 'Noto Sans KR', system-ui, sans-serif; word-break: keep-all; }
    
    /* 스크롤바 커스텀 (모바일 탭) */
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

    /* 부드러운 전환 */
    .transition-all-300 { transition: all 0.3s ease; }

    /* 토글 애니메이션 */
    details > summary { list-style: none; cursor: pointer; }
    details > summary::-webkit-details-marker { display: none; }
    details[open] summary ~ * { animation: sweep .3s ease-in-out; }
    @keyframes sweep { 0% {opacity: 0; margin-top: -10px} 100% {opacity: 1; margin-top: 0px} }

    /* 커스텀 UI 요소 */
    .btn-action { @apply active:scale-95 transition-transform shadow-sm; }
    .glass-nav { @apply bg-white/95 backdrop-blur supports-[backdrop-filter]:bg-white/80 border-b border-slate-200 sticky top-0 z-40; }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6', // 도입 (Blue)
            past: '#f59e0b',    // 과거 (Amber)
            present: '#10b981', // 현재 (Emerald)
            future: '#8b5cf6',  // 미래 (Violet)
          }
        }
      }
    }
  </script>
</head>

<body class="bg-slate-100 text-slate-800 pb-20">

<header class="glass-nav">
  <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
    <div>
      <h1 class="text-lg font-bold text-slate-900 leading-tight">🏡 고향 글쓰기</h1>
      <p class="text-xs text-slate-500 mt-0.5">중급 한국어 (KO-VI)</p>
    </div>
    <div class="flex items-center gap-2">
      <div id="saveIndicator" class="hidden text-xs font-medium text-blue-600 bg-blue-50 px-2 py-1 rounded-full animate-pulse">
        저장됨
      </div>
      <button id="resetAll" class="text-xs text-slate-400 underline p-2">초기화</button>
    </div>
  </div>
  <div class="h-1 w-full bg-slate-200">
    <div id="progressBar" class="h-1 bg-blue-500 transition-all duration-500" style="width: 0%"></div>
  </div>
</header>

<main class="max-w-3xl mx-auto px-4 py-4 space-y-6">

  <nav class="flex gap-2 overflow-x-auto scrollbar-hide pb-1">
    <button class="tab-btn whitespace-nowrap px-4 py-2 rounded-full text-sm font-medium border border-slate-300 bg-white text-slate-600 data-[active=true]:bg-blue-600 data-[active=true]:text-white data-[active=true]:border-transparent transition-colors shadow-sm" data-target="tab1">1. 도입</button>
    <button class="tab-btn whitespace-nowrap px-4 py-2 rounded-full text-sm font-medium border border-slate-300 bg-white text-slate-600 data-[active=true]:bg-amber-500 data-[active=true]:text-white data-[active=true]:border-transparent transition-colors shadow-sm" data-target="tab2">2. 과거</button>
    <button class="tab-btn whitespace-nowrap px-4 py-2 rounded-full text-sm font-medium border border-slate-300 bg-white text-slate-600 data-[active=true]:bg-emerald-500 data-[active=true]:text-white data-[active=true]:border-transparent transition-colors shadow-sm" data-target="tab3">3. 현재</button>
    <button class="tab-btn whitespace-nowrap px-4 py-2 rounded-full text-sm font-medium border border-slate-300 bg-white text-slate-600 data-[active=true]:bg-violet-500 data-[active=true]:text-white data-[active=true]:border-transparent transition-colors shadow-sm" data-target="tab4">4. 미래</button>
    <button class="tab-btn whitespace-nowrap px-4 py-2 rounded-full text-sm font-medium border border-slate-300 bg-white text-slate-600 data-[active=true]:bg-slate-800 data-[active=true]:text-white data-[active=true]:border-transparent transition-colors shadow-sm" data-target="tab5">최종 완성</button>
  </nav>

  <div class="flex justify-end">
    <label class="inline-flex items-center cursor-pointer gap-2">
      <span class="text-xs text-slate-500">🇻🇳 베트남어 설명</span>
      <input type="checkbox" id="toggleVI" class="sr-only peer" checked>
      <div class="relative w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
    </label>
  </div>

  <section id="tab1" class="tab-content space-y-6">
    <div class="bg-blue-50 border border-blue-100 rounded-xl p-4 shadow-sm">
      <h2 class="text-blue-800 font-bold text-lg flex items-center gap-2">
        <span class="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
        도입: 고향 소개
      </h2>
      <p class="text-sm text-blue-600 mt-1">고향의 위치와 유명한 것을 소개합니다.</p>
    </div>

    <div class="q-card bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
      <div class="p-4 border-b border-slate-100 bg-slate-50/50">
        <h3 class="font-bold text-slate-800">Q1. 고향은 어디입니까?</h3>
        <p class="vi-text text-sm text-indigo-600 mt-1">🇻🇳 Quê bạn ở đâu? (thành phố, vùng/tỉnh)</p>
      </div>
      
      <div class="p-4 space-y-3">
        <div class="flex gap-2 text-xs overflow-x-auto scrollbar-hide">
          <span class="px-2 py-1 bg-slate-100 rounded text-slate-600 whitespace-nowrap border">N(이/가) 있다</span>
          <span class="px-2 py-1 bg-slate-100 rounded text-slate-600 whitespace-nowrap border">N에 있다</span>
        </div>

        <textarea id="s1" class="input-area w-full p-3 rounded-xl border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all outline-none resize-none h-24 text-base" placeholder="예: 제 고향은 베트남 북쪽에 있습니다."></textarea>
        
        <details class="group bg-slate-50 rounded-xl border border-slate-200 text-sm">
          <summary class="flex justify-between items-center p-3 font-medium text-slate-600 select-none group-open:text-blue-600">
            <span>💡 추천 표현 및 예문</span>
            <span class="transform transition-transform group-open:rotate-180">▼</span>
          </summary>
          <div class="p-3 pt-0 border-t border-slate-200 mt-2">
             <ul class="space-y-2 text-slate-700 mt-2 list-disc pl-4 marker:text-blue-400">
               <li>제 고향은 <strong>하노이</strong>에 있습니다.</li>
               <li>제 고향은 <strong>바다 근처</strong>에 있습니다.</li>
             </ul>
             <div class="mt-3 flex gap-2 overflow-x-auto pb-1">
               <button class="ex-btn btn-action px-3 py-1.5 bg-white border border-slate-300 rounded-lg text-xs font-medium text-slate-700 whitespace-nowrap" data-target="s1" data-text="제 고향은 하노이에 있습니다.">"하노이" 삽입</button>
               <button class="ex-btn btn-action px-3 py-1.5 bg-white border border-slate-300 rounded-lg text-xs font-medium text-slate-700 whitespace-nowrap" data-target="s1" data-text="제 고향은 베트남 북쪽에 있습니다.">"북쪽" 삽입</button>
             </div>
          </div>
        </details>
      </div>
    </div>

    <div class="q-card bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
      <div class="p-4 border-b border-slate-100 bg-slate-50/50">
        <h3 class="font-bold text-slate-800">Q2. 고향은 무엇으로 유명합니까?</h3>
        <p class="vi-text text-sm text-indigo-600 mt-1">🇻🇳 Nổi tiếng về cái gì?</p>
      </div>
      <div class="p-4 space-y-3">
        <div class="flex gap-2 text-xs overflow-x-auto scrollbar-hide">
          <span class="px-2 py-1 bg-slate-100 rounded text-slate-600 whitespace-nowrap border">N(으)로 유명하다</span>
          <span class="px-2 py-1 bg-slate-100 rounded text-slate-600 whitespace-nowrap border">특히 (강조)</span>
        </div>
        <textarea id="s2" class="input-area w-full p-3 rounded-xl border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all outline-none resize-none h-24 text-base" placeholder="예: 쌀국수로 유명합니다."></textarea>
        
        <details class="group bg-slate-50 rounded-xl border border-slate-200 text-sm">
          <summary class="flex justify-between items-center p-3 font-medium text-slate-600 select-none group-open:text-blue-600">
            <span>💡 예문 보기</span>
            <span class="transform transition-transform group-open:rotate-180">▼</span>
          </summary>
          <div class="p-3 pt-0 border-t border-slate-200 mt-2">
             <ul class="space-y-2 text-slate-700 mt-2 list-disc pl-4 marker:text-blue-400">
               <li>제 고향은 <strong>아름다운 바다</strong>로 유명합니다.</li>
               <li>특히 <strong>맛있는 음식</strong>이 많습니다.</li>
             </ul>
             <div class="mt-3 flex gap-2">
               <button class="ex-btn btn-action px-3 py-1.5 bg-white border border-slate-300 rounded-lg text-xs font-medium text-slate-700" data-target="s2" data-text="제 고향은 아름다운 바다로 유명합니다.">예문 삽입</button>
             </div>
          </div>
        </details>
      </div>
    </div>

    <div class="q-card bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
        <div class="p-4 border-b border-slate-100 bg-slate-50/50">
          <h3 class="font-bold text-slate-800">Q3. 무엇을 소개하고 싶습니까?</h3>
          <p class="vi-text text-sm text-indigo-600 mt-1">🇻🇳 Bạn muốn giới thiệu điều gì?</p>
        </div>
        <div class="p-4 space-y-3">
          <textarea id="s3" class="input-area w-full p-3 rounded-xl border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all outline-none resize-none h-24 text-base" placeholder="예: 고향의 변화에 대해 소개하겠습니다."></textarea>
          <details class="group bg-slate-50 rounded-xl border border-slate-200 text-sm">
            <summary class="flex justify-between items-center p-3 font-medium text-slate-600 select-none group-open:text-blue-600">
              <span>💡 예문 보기</span>
              <span class="transform transition-transform group-open:rotate-180">▼</span>
            </summary>
            <div class="p-3 pt-0 border-t border-slate-200 mt-2">
               <div class="mt-3 flex gap-2">
                 <button class="ex-btn btn-action px-3 py-1.5 bg-white border border-slate-300 rounded-lg text-xs font-medium text-slate-700" data-target="s3" data-text="이번 글에서는 고향의 변화에 대해 소개하겠습니다.">예문 삽입</button>
               </div>
            </div>
          </details>
        </div>
      </div>

    <div class="bg-slate-800 text-white p-4 rounded-xl shadow-lg flex flex-col gap-3">
        <div class="flex justify-between items-center">
            <span class="text-sm font-semibold">1단계 문단 완성하기</span>
            <button class="make-paragraph btn-action px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm font-bold shadow" data-section="1">합치기 & 저장</button>
        </div>
        <textarea id="p1Out" class="w-full h-32 bg-slate-700 border-none rounded-lg text-sm p-3 focus:ring-2 focus:ring-blue-400 text-slate-100" placeholder="[합치기] 버튼을 누르면 문장이 여기에 모입니다. 수정할 수 있습니다."></textarea>
    </div>
  </section>


  <section id="tab2" class="tab-content hidden space-y-6">
    <div class="bg-amber-50 border border-amber-100 rounded-xl p-4 shadow-sm">
      <h2 class="text-amber-800 font-bold text-lg flex items-center gap-2">
        <span class="bg-amber-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
        과거: 어렸을 때 모습
      </h2>
    </div>

    <div class="q-card bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
        <div class="p-4 border-b border-slate-100 bg-slate-50/50">
          <h3 class="font-bold text-slate-800">Q4. 어렸을 때 분위기는 어땠습니까?</h3>
          <p class="vi-text text-sm text-indigo-600 mt-1">🇻🇳 Hồi nhỏ không khí thế nào?</p>
        </div>
        <div class="p-4 space-y-3">
            <div class="flex gap-2 text-xs overflow-x-auto scrollbar-hide">
                <span class="px-2 py-1 bg-amber-50 text-amber-700 rounded border border-amber-100">A/V-았습니다/었습니다</span>
                <span class="px-2 py-1 bg-amber-50 text-amber-700 rounded border border-amber-100">N(이)었습니다</span>
            </div>
          <textarea id="s4" class="input-area w-full p-3 rounded-xl border border-slate-300 focus:border-amber-500 focus:ring-2 focus:ring-amber-200 transition-all outline-none resize-none h-24 text-base" placeholder="예: 조용하고 공기가 좋았습니다."></textarea>
          <details class="group bg-slate-50 rounded-xl border border-slate-200 text-sm">
            <summary class="flex justify-between items-center p-3 font-medium text-slate-600">
              <span>💡 예문 보기</span> <span class="text-xs text-slate-400">▼</span>
            </summary>
            <div class="p-3 pt-0 mt-2 border-t border-slate-200">
               <div class="flex gap-2 flex-wrap mt-2">
                 <button class="ex-btn btn-action px-3 py-1 bg-white border rounded text-xs" data-target="s4" data-text="어렸을 때 제 고향은 조용한 시골 마을이었습니다.">"조용한 마을"</button>
                 <button class="ex-btn btn-action px-3 py-1 bg-white border rounded text-xs" data-target="s4" data-text="그때는 공기가 깨끗했습니다.">"공기 깨끗"</button>
               </div>
            </div>
          </details>
        </div>
    </div>

    <div class="q-card bg-white rounded-2xl border border-slate-200 shadow-sm p-4">
        <h3 class="font-bold text-slate-800 mb-2">Q5~Q8. 과거의 집, 자연, 생활 모습</h3>
        <p class="text-xs text-slate-500 mb-2">한 번에 이어서 써보세요.</p>
        <textarea id="s5_8_combined" class="input-area w-full p-3 rounded-xl border border-slate-300 focus:border-amber-500 focus:ring-2 focus:ring-amber-200 transition-all outline-none resize-none h-40 text-base" placeholder="예: 높은 건물이 없었고 낮은 집들이 많았습니다. 이웃끼리 서로 도와주곤 했습니다."></textarea>
        <div class="flex gap-2 mt-2 overflow-x-auto pb-1">
             <button class="ex-btn btn-action px-3 py-1 bg-slate-100 rounded text-xs text-slate-700 whitespace-nowrap" data-target="s5_8_combined" data-text="높은 건물이 없었고 낮은 집들이 많았습니다.">집 묘사</button>
             <button class="ex-btn btn-action px-3 py-1 bg-slate-100 rounded text-xs text-slate-700 whitespace-nowrap" data-target="s5_8_combined" data-text="이웃끼리 서로 도와주곤 했습니다.">이웃 묘사</button>
             <button class="ex-btn btn-action px-3 py-1 bg-slate-100 rounded text-xs text-slate-700 whitespace-nowrap" data-target="s5_8_combined" data-text="강에서 친구들과 수영하곤 했습니다.">놀이 묘사</button>
        </div>
    </div>

    <div class="bg-slate-800 text-white p-4 rounded-xl shadow-lg flex flex-col gap-3">
        <div class="flex justify-between items-center">
            <span class="text-sm font-semibold">2단계 문단 완성</span>
            <button class="make-paragraph btn-action px-4 py-2 bg-amber-500 hover:bg-amber-600 rounded-lg text-sm font-bold shadow" data-section="2">합치기 & 저장</button>
        </div>
        <textarea id="p2Out" class="w-full h-32 bg-slate-700 border-none rounded-lg text-sm p-3 focus:ring-2 focus:ring-amber-400 text-slate-100"></textarea>
    </div>
  </section>

  <section id="tab3" class="tab-content hidden space-y-6">
    <div class="bg-emerald-50 border border-emerald-100 rounded-xl p-4 shadow-sm">
        <h2 class="text-emerald-800 font-bold text-lg flex items-center gap-2">
          <span class="bg-emerald-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">3</span>
          현재: 변화와 장점
        </h2>
    </div>
    
    <div class="space-y-4">
        <div class="q-card bg-white rounded-2xl border border-slate-200 shadow-sm p-4">
            <h3 class="font-bold text-slate-800">Q9-10. 가장 크게 변한 것과 이유</h3>
            <p class="vi-text text-sm text-indigo-600 mt-1">Thay đổi lớn nhất và lý do?</p>
            <textarea id="s9_10" class="mt-2 w-full p-3 rounded-xl border border-slate-300 focus:border-emerald-500 h-28" placeholder="예: 교통이 가장 크게 변했습니다. 관광객이 늘었기 때문입니다."></textarea>
        </div>
        <div class="q-card bg-white rounded-2xl border border-slate-200 shadow-sm p-4">
            <h3 class="font-bold text-slate-800">Q11-13. 변화의 장점과 문제점</h3>
            <p class="vi-text text-sm text-indigo-600 mt-1">Ưu điểm và vấn đề?</p>
            <textarea id="s11_13" class="mt-2 w-full p-3 rounded-xl border border-slate-300 focus:border-emerald-500 h-32" placeholder="예: 이동이 편리해졌지만, 차가 많아서 복잡합니다."></textarea>
        </div>
    </div>

    <div class="bg-slate-800 text-white p-4 rounded-xl shadow-lg flex flex-col gap-3">
        <div class="flex justify-between items-center">
            <span class="text-sm font-semibold">3단계 문단 완성</span>
            <button class="make-paragraph btn-action px-4 py-2 bg-emerald-500 hover:bg-emerald-600 rounded-lg text-sm font-bold shadow" data-section="3">합치기 & 저장</button>
        </div>
        <textarea id="p3Out" class="w-full h-32 bg-slate-700 border-none rounded-lg text-sm p-3 focus:ring-2 focus:ring-emerald-400 text-slate-100"></textarea>
    </div>
  </section>


  <section id="tab4" class="tab-content hidden space-y-6">
    <div class="bg-violet-50 border border-violet-100 rounded-xl p-4 shadow-sm">
        <h2 class="text-violet-800 font-bold text-lg flex items-center gap-2">
          <span class="bg-violet-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">4</span>
          미래: 바람과 마무리
        </h2>
    </div>

    <div class="q-card bg-white rounded-2xl border border-slate-200 shadow-sm p-4">
        <h3 class="font-bold text-slate-800">Q14-17. 바라는 점과 마무리</h3>
        <p class="vi-text text-sm text-indigo-600 mt-1">Mong muốn thay đổi điều gì? Tóm tắt 1 câu.</p>
        <div class="mt-2 flex gap-2 text-xs mb-2">
            <span class="px-2 py-1 bg-violet-50 text-violet-700 rounded border border-violet-100">V-(으)면 좋겠다</span>
            <span class="px-2 py-1 bg-violet-50 text-violet-700 rounded border border-violet-100">V-(으)ㄹ 필요가 있다</span>
        </div>
        <textarea id="s14_17" class="w-full p-3 rounded-xl border border-slate-300 focus:border-violet-500 h-32" placeholder="예: 공원이 더 많아졌으면 좋겠습니다. 저에게 고향은 언제나 그리운 곳입니다."></textarea>
        <div class="mt-2 flex gap-2">
            <button class="ex-btn btn-action px-3 py-1 bg-slate-100 rounded text-xs" data-target="s14_17" data-text="공기가 더 깨끗해졌으면 좋겠습니다.">"공기"</button>
            <button class="ex-btn btn-action px-3 py-1 bg-slate-100 rounded text-xs" data-target="s14_17" data-text="저에게 고향은 잊을 수 없는 곳입니다.">"마무리"</button>
        </div>
    </div>

    <div class="bg-slate-800 text-white p-4 rounded-xl shadow-lg flex flex-col gap-3">
        <div class="flex justify-between items-center">
            <span class="text-sm font-semibold">4단계 문단 완성</span>
            <button class="make-paragraph btn-action px-4 py-2 bg-violet-500 hover:bg-violet-600 rounded-lg text-sm font-bold shadow" data-section="4">합치기 & 저장</button>
        </div>
        <textarea id="p4Out" class="w-full h-32 bg-slate-700 border-none rounded-lg text-sm p-3 focus:ring-2 focus:ring-violet-400 text-slate-100"></textarea>
    </div>
  </section>

  <section id="tab5" class="tab-content hidden space-y-6">
    <div class="text-center py-6">
      <div class="inline-block p-3 rounded-full bg-slate-200 mb-3 text-2xl">🎉</div>
      <h2 class="text-2xl font-bold text-slate-900">글쓰기 완성</h2>
      <p class="text-slate-500">각 단계에서 작성한 내용을 모두 모았습니다.</p>
    </div>

    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-1">
        <textarea id="finalOut" class="w-full min-h-[400px] p-6 text-base leading-relaxed text-slate-800 outline-none rounded-xl resize-y" placeholder="앞 단계에서 [합치기] 버튼을 누르면 자동으로 글이 완성됩니다."></textarea>
    </div>

    <div class="fixed bottom-6 left-0 right-0 px-4 flex justify-center gap-3 z-50">
        <button id="btnCopy" class="btn-action shadow-xl bg-white text-slate-800 border border-slate-200 px-6 py-3 rounded-full font-bold flex items-center gap-2">
            📋 복사하기
        </button>
        <button id="btnDownload" class="btn-action shadow-xl bg-slate-900 text-white px-6 py-3 rounded-full font-bold flex items-center gap-2">
            💾 파일 저장 (.txt)
        </button>
    </div>
    <div class="h-16"></div> </section>

</main>

<div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-slate-800/90 text-white px-4 py-2 rounded-full text-sm font-medium opacity-0 pointer-events-none transition-opacity duration-300 z-50">
  알림 메시지
</div>

<script>
    // === 유틸리티 ===
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => document.querySelectorAll(s);

    function showToast(msg) {
        const t = $('#toast');
        t.textContent = msg;
        t.classList.remove('opacity-0');
        setTimeout(() => t.classList.add('opacity-0'), 2000);
    }

    // === 탭 로직 ===
    const tabs = $$('.tab-btn');
    const contents = $$('.tab-content');
    const progressBar = $('#progressBar');

    function switchTab(targetId) {
        // 콘텐츠 전환
        contents.forEach(c => c.classList.add('hidden'));
        $(`#${targetId}`).classList.remove('hidden');
        
        // 버튼 스타일 업데이트
        tabs.forEach(t => t.setAttribute('data-active', 'false'));
        $(`.tab-btn[data-target="${targetId}"]`).setAttribute('data-active', 'true');

        // 진행률 업데이트
        const idx = ['tab1','tab2','tab3','tab4','tab5'].indexOf(targetId);
        progressBar.style.width = `${(idx + 1) * 20}%`;
        
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    tabs.forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.target));
    });

    // === 베트남어 토글 ===
    $('#toggleVI').addEventListener('change', (e) => {
        $$('.vi-text').forEach(el => el.style.display = e.target.checked ? 'block' : 'none');
    });

    // === 예문 삽입 ===
    $$('.ex-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const target = $(`#${btn.dataset.target}`);
            const text = btn.dataset.text;
            
            // 기존 텍스트가 있으면 뒤에 추가, 없으면 바로 삽입
            if(target.value.length > 0 && !target.value.endsWith(' ')) {
                target.value += ' '; 
            }
            target.value += text;
            target.focus();
            
            // 효과: 반짝임
            target.classList.add('bg-blue-50');
            setTimeout(()=>target.classList.remove('bg-blue-50'), 300);
            showToast('예문이 추가되었습니다');
            saveData();
        });
    });

    // === 단락 합치기 로직 ===
    $$('.make-paragraph').forEach(btn => {
        btn.addEventListener('click', () => {
            const section = btn.dataset.section;
            let sources = [];
            
            // 섹션별 입력창 ID 매핑
            if(section === '1') sources = ['s1', 's2', 's3'];
            else if(section === '2') sources = ['s4', 's5_8_combined']; // 병합된 입력창 대응
            else if(section === '3') sources = ['s9_10', 's11_13'];
            else if(section === '4') sources = ['s14_17'];

            const textArr = sources.map(id => {
                const el = $(`#${id}`);
                return el ? el.value.trim() : '';
            }).filter(t => t.length > 0);

            const resultEl = $(`#p${section}Out`);
            resultEl.value = textArr.join(' ');
            
            showToast('단락이 저장되었습니다');
            saveData();
            updateFinalText();
        });
    });

    // === 최종 글 업데이트 ===
    function updateFinalText() {
        const p1 = $('#p1Out').value;
        const p2 = $('#p2Out').value;
        const p3 = $('#p3Out').value;
        const p4 = $('#p4Out').value;
        
        // 문단바꿈(\n\n)으로 연결
        $('#finalOut').value = [p1, p2, p3, p4].filter(t => t.trim().length > 0).join('\n\n');
    }

    // === 자동 저장 (LocalStorage) ===
    function saveData() {
        const data = {};
        $$('textarea').forEach(el => data[el.id] = el.value);
        localStorage.setItem('kovi_writer_v3', JSON.stringify(data));
        
        const ind = $('#saveIndicator');
        ind.classList.remove('hidden');
        setTimeout(()=>ind.classList.add('hidden'), 2000);
    }

    function loadData() {
        const raw = localStorage.getItem('kovi_writer_v3');
        if(!raw) return;
        const data = JSON.parse(raw);
        for(const [id, val] of Object.entries(data)) {
            const el = $(`#${id}`);
            if(el) el.value = val;
        }
    }

    // 입력시 저장 (디바운스)
    let saveTimeout;
    document.body.addEventListener('input', (e) => {
        if(e.target.tagName === 'TEXTAREA') {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveData, 500);
        }
    });

    // === 복사 및 다운로드 ===
    $('#btnCopy').addEventListener('click', () => {
        const text = $('#finalOut').value;
        if(!text) { showToast('내용이 없습니다'); return; }
        navigator.clipboard.writeText(text).then(() => showToast('전체 글 복사 완료!'));
    });

    $('#btnDownload').addEventListener('click', () => {
        const text = $('#finalOut').value;
        if(!text) { showToast('내용이 없습니다'); return; }
        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "나의_고향_소개.txt";
        a.click();
    });

    $('#resetAll').addEventListener('click', () => {
        if(confirm('모든 내용을 지우시겠습니까?')) {
            localStorage.removeItem('kovi_writer_v3');
            $$('textarea').forEach(el => el.value = '');
            showToast('초기화되었습니다');
            switchTab('tab1');
        }
    });

    // 초기 실행
    loadData();
    switchTab('tab1');

</script>
</body>
</html>
